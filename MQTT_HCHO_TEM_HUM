#include <ESP8266WiFi.h>
#include <PubSubClient.h>
#include <SoftwareSerial.h>
// ============ ç”¨æˆ·é…ç½® ============
// WiFiè¿æ¥ä¿¡æ¯
const char* ssid = "Y";
const char* password = "2271911458";

// é˜¿é‡Œäº‘ MQTT è¿æ¥é…ç½®
const char* mqtt_server = "your mqttserver";
const int mqtt_port = ;
const char* mqtt_client_id = "your clientid";
const char* mqtt_username = "your username";
const char* mqtt_password = "your password";

// å‘å¸ƒtopic
const char* publish_topic = "your topic";

// ============ HCHOä¼ æ„Ÿå™¨ä¸²å£é…ç½® ============
#define SENSOR_RX D5  // è½¯ä»¶ä¸²å£æ¥æ”¶å¼•è„š
#define SENSOR_TX D6  // è½¯ä»¶ä¸²å£å‘é€å¼•è„š

SoftwareSerial sensorSerial(SENSOR_RX, SENSOR_TX); // RX, TX
WiFiClient espClient;
PubSubClient client(espClient);

// å‡½æ•°åŸå‹
void reconnect();
void sendSensorData();

// ============ åˆå§‹åŒ– ============
void setup() 
{
  Serial.begin(115200);
  sensorSerial.begin(9600);

  WiFi.begin(ssid, password);
  Serial.print("è¿æ¥ WiFi");

  while (WiFi.status() != WL_CONNECTED) 
  {
    delay(500);
    Serial.print(".");
    delay(5000);
    break;//æ–°å¢
  }

  Serial.println("\nâœ… WiFiå·²è¿æ¥");
  Serial.print("IPåœ°å€: ");
  Serial.println(WiFi.localIP());

  client.setServer(mqtt_server, mqtt_port);
}

// ============ ä¸»å¾ªç¯ ============
void loop()
{
  if (!client.connected())
   {
    reconnect();
   }

    client.loop();
  static unsigned long lastSend = 0;

  if (millis() - lastSend > 5000)
   {
    lastSend = millis();
    sendSensorData(); // æ¯5ç§’å‘é€ä¸€æ¬¡
  }
}

// ============ é‡è¿MQTT ============
void reconnect() 
{
  while (!client.connected()) 
  {
    Serial.print("å°è¯•è¿æ¥MQTT...");
    if (client.connect(mqtt_client_id, mqtt_username, mqtt_password)) 
    {
      Serial.println("âœ… MQTTè¿æ¥æˆåŠŸ");
    } 
    else {
      Serial.print("âŒ å¤±è´¥ï¼Œrc=");
      Serial.println(client.state());
      delay(3000);
      break;//æ–°å¢
    }
  }
}

// ============ è¯»å–å¹¶ä¸Šä¼ ç”²é†›æµ“åº¦ ============
void sendSensorData()
 {
  uint8_t buffer[9];

  // æ¸…ç©ºç¼“å†²åŒº
  while (sensorSerial.available()) sensorSerial.read();

  // ç­‰å¾…å®Œæ•´æ•°æ®å¸§
  int index = 0;
  unsigned long start = millis();
  while (index < 9 && millis() - start < 1000)
   {
    if (sensorSerial.available())
     {
      buffer[index++] = sensorSerial.read();
    }
  }

  if (index == 9 && buffer[0] == 0xFF) 
  {
    uint8_t checksum = ~(buffer[1] + buffer[2] + buffer[3] + buffer[4] + buffer[5] + buffer[6] + buffer[7]) + 1;
    if (checksum == buffer[8]) 
    {
      uint16_t concentration = (buffer[4] << 8) | buffer[5]; // é«˜ä½ + ä½ä½

      // æ‰“å°ç”²é†›æµ“åº¦
      float mg = concentration / 1000.0;
      Serial.print("ğŸŒ«ï¸ ç”²é†›æµ“åº¦: ");
      Serial.print(mg);
      Serial.println(" mg/mÂ³");

      // æ„é€  JSON æ•°æ®ä¸Šä¼ 
      String payload = "{\"id\":\"1\",\"version\":\"1.0\",\"params\":{\"HCHO\":" + String(mg, 3) + "},\"method\":\"thing.event.property.post\"}";

        if (client.publish(publish_topic, payload.c_str()))
        {
          Serial.println("ğŸ“¡ æ•°æ®å·²ä¸Šä¼ é˜¿é‡Œäº‘");
        } 

        else
        {
          Serial.println("âŒ æ•°æ®ä¸Šä¼ å¤±è´¥");
        }
    }
     else 
     {
      Serial.println("âŒ æ ¡éªŒå¤±è´¥ï¼Œæ•°æ®è¢«ä¸¢å¼ƒ");
    }
  } 
  else 
  {
    Serial.println("âŒ æ¥æ”¶è¶…æ—¶æˆ–æ ¼å¼é”™è¯¯");
  }
}
